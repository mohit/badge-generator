<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Credentials | Open Badges by Firmament Works</title>
  <meta name="description" content="Check any badge trust state by URL or JSON. Domain-bound verification with explicit result details.">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <meta property="og:title" content="Verify Credentials | Open Badges by Firmament Works">
  <meta property="og:description" content="Public Open Badges verifier with domain-bound trust state and auditable details.">
  <meta property="og:image" content="https://badges.firmament.works/og-image.png">
  <meta property="og:url" content="https://badges.firmament.works/verify.html">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <header class="site-header">
    <nav class="site-nav container" aria-label="Primary">
      <a href="/" class="logo">
        <span class="logo-mark" aria-hidden="true"></span>
        <span class="logo-main">Open Badges</span>
        <span class="logo-byline">by Firmament Works</span>
      </a>
      <button class="mobile-menu-btn" type="button" aria-expanded="false" aria-controls="primary-nav">Menu</button>
      <ul class="nav-links" id="primary-nav">
        <li><a href="/">Home</a></li>
        <li><a href="/verify.html" class="active">Verify</a></li>
        <li><a href="/api.html">API</a></li>
        <li><a href="/vision.html">Vision</a></li>
      </ul>
    </nav>
  </header>

  <main id="main-content">
    <section class="verify-hero">
      <div class="container">
        <p class="kicker">Public Verifier</p>
        <h1 class="section-title" style="margin-bottom: 0.45rem;">Check any badge's trust state</h1>
        <p class="section-lede">Paste a URL, drop in JSON, or inspect an issuer profile. The verifier checks structure, issuer reachability, and signature, then shows exactly what it found.</p>
        <div class="cta-row" style="margin-top: 0.85rem;">
          <a href="#" class="btn btn-primary" data-demo-fill-link>Load live signed credential</a>
          <a href="/challenge.html" class="btn btn-secondary">Verify challenge</a>
        </div>
      </div>
    </section>

    <section class="section" style="padding-top: 0.5rem;">
      <div class="container verify-layout">
        <section class="panel verify-panel">
          <div class="verify-tabs">
            <div class="verify-tab active" data-tab="url">By URL</div>
            <div class="verify-tab" data-tab="json">By JSON</div>
            <div class="verify-tab" data-tab="issuer">Issuer</div>
          </div>

          <div class="tab-content active" id="url-tab">
            <form id="url-form">
              <div class="form-group">
                <label class="form-label" for="badge-url">Badge or credential URL</label>
                <input type="url" id="badge-url" class="form-input" placeholder="https://example.com/badges/assertion.json" required>
                <small class="form-help">Fetches the resource and runs trust checks.</small>
              </div>
              <button type="submit" class="verify-button">
                <span class="button-text">Verify URL</span>
                <span class="loading-spinner" style="display: none;"></span>
              </button>
            </form>
          </div>

          <div class="tab-content" id="json-tab">
            <form id="json-form">
              <div class="form-group">
                <label class="form-label" for="badge-json">Badge JSON payload</label>
                <textarea id="badge-json" class="form-input form-textarea" placeholder='{"@context":"https://www.w3.org/ns/credentials/v2","type":["VerifiableCredential","OpenBadgeCredential"],...}' required></textarea>
                <small class="form-help">Paste a full JSON object.</small>
              </div>
              <button type="submit" class="verify-button">
                <span class="button-text">Verify JSON</span>
                <span class="loading-spinner" style="display: none;"></span>
              </button>
            </form>
          </div>

          <div class="tab-content" id="issuer-tab">
            <form id="issuer-form">
              <div class="form-group">
                <label class="form-label" for="issuer-url">Issuer URL</label>
                <input type="url" id="issuer-url" class="form-input" placeholder="https://example.com/.well-known/openbadges-issuer.json" required>
                <small class="form-help">Checks issuer resource validity and key discoverability.</small>
              </div>
              <button type="submit" class="verify-button">
                <span class="button-text">Verify issuer</span>
                <span class="loading-spinner" style="display: none;"></span>
              </button>
            </form>
          </div>

          <div id="result-container" class="result-container" role="status" aria-live="polite">
            <div class="result-title">
              <span class="result-icon"></span>
              <span class="result-text"></span>
            </div>
            <div class="result-details"></div>
          </div>

          <div class="examples">
            <h3>Quick examples</h3>
            <div class="example-links">
              <a href="#" class="example-link" data-example="live">Live signed test</a>
              <a href="#" class="example-link" data-example="unsigned">Unsigned sample</a>
              <a href="#" class="example-link" data-example="issuer">Sample issuer</a>
              <a href="#" class="example-link" data-example="domain">openbadges.org</a>
            </div>
          </div>
        </section>

        <aside class="panel verify-panel scroll-animate">
          <h2 class="panel-title">How to read the verdict</h2>
          <div class="signal-stack">
            <div class="signal-row"><span class="signal-key">DOMAIN_VERIFIED_SIGNATURE</span><span class="status-pill status-pass">signature + domain key pass</span></div>
            <div class="signal-row"><span class="signal-key">UNVERIFIED</span><span class="status-pill status-fail">issuer not cryptographically verified</span></div>
            <div class="signal-row"><span class="signal-key">DEMO</span><span class="status-pill status-warn">reserved example.com issuer domain</span></div>
          </div>
          <p class="signal-note" style="margin-top: 0.8rem;">
            This verifies domain/key control. It does not certify assessment quality or accreditation.
          </p>

          <div class="card" style="margin-top: 0.95rem;">
            <p class="eyebrow">Public endpoint</p>
            <code class="code-chip">GET /public/api/verify/badge/:badgeUrl(*)</code>
          </div>
          <div class="card" style="margin-top: 0.75rem;">
            <p class="eyebrow">Need implementation details?</p>
            <p class="small-note">See API and llms.txt links in the footer.</p>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <footer>
    <div class="container footer-row">
      <p>Built by <a href="https://firmament.works" target="_blank" rel="noreferrer">Firmament Works</a>.</p>
      <div class="footer-links">
        <a href="/">Home</a>
        <a href="/api.html">API</a>
        <a href="/vision.html">Vision</a>
        <a href="/challenge.html">Challenge</a>
        <a href="/llms.txt">llms.txt</a>
      </div>
    </div>
  </footer>

  <script>
    const TRUST_STATES = {
      UNVERIFIED: 'UNVERIFIED',
      DOMAIN_VERIFIED_SIGNATURE: 'DOMAIN_VERIFIED_SIGNATURE'
    };

    document.querySelectorAll('.verify-tab').forEach((tab) => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.verify-tab').forEach((t) => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        document.getElementById('result-container').style.display = 'none';
      });
    });

    const examples = {
      live: `${window.location.origin}/samples/demo-openbadge-v3-signed.json`,
      unsigned: `${window.location.origin}/samples/demo-openbadge-v3.json`,
      issuer: 'https://example.com/.well-known/openbadges-issuer.json',
      domain: 'https://openbadges.org'
    };

    const statusClassMap = {
      pass: 'status-pass',
      warn: 'status-warn',
      fail: 'status-fail',
      skip: 'status-skip'
    };

    const statusTextMap = {
      pass: 'pass',
      warn: 'warn',
      fail: 'fail',
      skip: 'skip'
    };

    function escapeHtml(input) {
      return String(input)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function statusPill(state, text) {
      const css = statusClassMap[state] || 'status-skip';
      const label = escapeHtml(text || statusTextMap[state] || 'skip');
      return `<span class="status-pill ${css}">${label}</span>`;
    }

    function ladderRow(label, state, text) {
      return `<div class="result-ladder-row"><span class="label">${escapeHtml(label)}</span>${statusPill(state, text)}</div>`;
    }

    function trustBadge(trustState) {
      if (trustState === TRUST_STATES.DOMAIN_VERIFIED_SIGNATURE) {
        return '<span class="trust-badge trust-badge--verified">DOMAIN_VERIFIED_SIGNATURE</span>';
      }
      return '<span class="trust-badge trust-badge--unverified">UNVERIFIED</span>';
    }

    function isDemoDomain(domain) {
      if (!domain) return false;
      try {
        const parsed = new URL(String(domain).includes('://') ? domain : `https://${domain}`);
        const hostname = parsed.hostname.toLowerCase();
        return hostname === 'example.com' || hostname.endsWith('.example.com');
      } catch {
        return false;
      }
    }

    function resolveValidationLabel(result, issuerDomain) {
      const explicitLabel = result.validationLabel || result.verification?.validationLabel || null;
      if (explicitLabel) return explicitLabel;
      return isDemoDomain(issuerDomain) ? 'DEMO' : null;
    }

    function trustHeadline(trustState, issuerDomain, validationLabel) {
      if (trustState === TRUST_STATES.DOMAIN_VERIFIED_SIGNATURE) {
        const label = validationLabel ? ` ${statusPill('warn', validationLabel)}` : '';
        return `Signed by verified domain: <code>${escapeHtml(issuerDomain || 'unknown')}</code>${label}`;
      }
      return 'Issuer cannot be cryptographically verified.';
    }

    function sharedCaveat() {
      return 'This verifies domain/key control. It does not certify assessment quality or accreditation.';
    }

    document.querySelectorAll('.example-link').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const type = link.dataset.example;
        if (type === 'live' || type === 'unsigned') {
          document.querySelector('[data-tab="url"]').click();
          document.getElementById('badge-url').value = examples[type];
          return;
        }
        if (type === 'domain') {
          document.querySelector('[data-tab="issuer"]').click();
          document.getElementById('issuer-url').value = examples.domain;
          return;
        }

        document.querySelector('[data-tab="issuer"]').click();
        document.getElementById('issuer-url').value = examples.issuer;
      });
    });

    document.getElementById('url-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await verifyByUrl(document.getElementById('badge-url').value);
    });

    document.getElementById('json-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await verifyByJson(document.getElementById('badge-json').value);
    });

    document.getElementById('issuer-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await verifyIssuer(document.getElementById('issuer-url').value);
    });

    document.querySelectorAll('[data-demo-fill-link]').forEach((element) => {
      element.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelector('[data-tab="url"]').click();
        document.getElementById('badge-url').value = examples.live;
        verifyByUrl(examples.live);
      });
    });

    async function verifyByUrl(url) {
      const button = document.querySelector('#url-form .verify-button');
      const buttonText = button.querySelector('.button-text');
      const spinner = button.querySelector('.loading-spinner');

      try {
        showLoading(button, buttonText, spinner);
        const response = await fetch(`/public/api/verify/badge/${encodeURIComponent(url)}`);
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);
        showBadgeResult(result);
      } catch (error) {
        showError(`Verification failed: ${error.message}`);
      } finally {
        hideLoading(button, buttonText, spinner);
      }
    }

    async function verifyByJson(jsonStr) {
      const button = document.querySelector('#json-form .verify-button');
      const buttonText = button.querySelector('.button-text');
      const spinner = button.querySelector('.loading-spinner');

      try {
        showLoading(button, buttonText, spinner);
        const badgeData = JSON.parse(jsonStr);
        const response = await fetch('/public/api/verify/json', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ badgeData })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);
        showBadgeResult(result);
      } catch (error) {
        if (error instanceof SyntaxError) {
          showError('Invalid JSON format.');
        } else {
          showError(`Verification failed: ${error.message}`);
        }
      } finally {
        hideLoading(button, buttonText, spinner);
      }
    }

    async function verifyIssuer(url) {
      const button = document.querySelector('#issuer-form .verify-button');
      const buttonText = button.querySelector('.button-text');
      const spinner = button.querySelector('.loading-spinner');

      try {
        showLoading(button, buttonText, spinner);
        const response = await fetch(`/public/api/verify/issuer/${encodeURIComponent(url)}`);
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);
        showIssuerResult(result);
      } catch (error) {
        showError(`Issuer verification failed: ${error.message}`);
      } finally {
        hideLoading(button, buttonText, spinner);
      }
    }

    function showBadgeResult(result) {
      const container = document.getElementById('result-container');
      const icon = container.querySelector('.result-icon');
      const text = container.querySelector('.result-text');
      const details = container.querySelector('.result-details');

      const structureState = result.structure ? (result.structure.valid ? 'pass' : 'fail') : 'skip';
      const issuerState = result.issuer ? (result.issuer.valid ? 'pass' : 'fail') : 'skip';
      const signatureState = result.signature ? (result.signature.valid ? 'pass' : 'fail') : 'skip';
      const trustState = result.trustState || TRUST_STATES.UNVERIFIED;
      const issuerDomain = result.issuerDomain || result.issuer?.issuerDomain || 'unknown';
      const validationLabel = resolveValidationLabel(result, issuerDomain);
      const issuerClaimedName = result.issuerClaimedName || result.issuer?.issuerClaimedName || result.issuer?.issuer?.name || 'not provided';
      const keyFingerprint = result.keyFingerprint || result.signature?.keyFingerprint || 'not available';
      const reason = result.verificationReason || (trustState === TRUST_STATES.DOMAIN_VERIFIED_SIGNATURE
        ? 'Signature is valid and key is currently discoverable for this domain.'
        : 'Issuer cannot be cryptographically verified.');

      const status = trustState === TRUST_STATES.DOMAIN_VERIFIED_SIGNATURE ? 'success' : 'error';
      icon.textContent = trustState === TRUST_STATES.DOMAIN_VERIFIED_SIGNATURE ? 'PASS' : 'FAIL';
      text.innerHTML = `${trustHeadline(trustState, issuerDomain, validationLabel)} ${trustBadge(trustState)}`;

      let detailsHtml = '';
      detailsHtml += `<p class="result-summary"><strong>Version:</strong> ${escapeHtml(result.version || 'unknown')} &nbsp; <strong>Level:</strong> ${escapeHtml(result.verificationLevel || 'unknown')}</p>`;
      detailsHtml += '<div class="issuer-block">';
      detailsHtml += `<div class="issuer-block__domain">Issued by ${escapeHtml(issuerDomain)}</div>`;
      if (validationLabel) {
        detailsHtml += `<div class="issuer-block__meta">Validation label: ${statusPill('warn', validationLabel)}</div>`;
      }
      detailsHtml += `<div class="issuer-block__meta">Claimed name: ${escapeHtml(issuerClaimedName)}</div>`;
      detailsHtml += `<div class="issuer-block__fingerprint">Key fingerprint: ${escapeHtml(keyFingerprint)}</div>`;
      detailsHtml += '</div>';
      detailsHtml += `<p class="small-note" style="margin-top:0.55rem;">${escapeHtml(reason)}</p>`;
      detailsHtml += '<div class="result-ladder">';
      detailsHtml += ladderRow('Structure', structureState, statusTextMap[structureState]);
      detailsHtml += ladderRow('Issuer', issuerState, statusTextMap[issuerState]);
      detailsHtml += ladderRow('Signature', signatureState, signatureState === 'skip' ? 'not present' : statusTextMap[signatureState]);
      detailsHtml += '</div>';

      if (result.structure?.errors?.length) {
        detailsHtml += '<div class="result-list"><p>Errors</p><ul>';
        result.structure.errors.forEach((entry) => {
          detailsHtml += `<li>${escapeHtml(entry)}</li>`;
        });
        detailsHtml += '</ul></div>';
      }

      if (result.structure?.warnings?.length) {
        detailsHtml += '<div class="result-list"><p>Warnings</p><ul>';
        result.structure.warnings.forEach((entry) => {
          detailsHtml += `<li>${escapeHtml(entry)}</li>`;
        });
        detailsHtml += '</ul></div>';
      }

      detailsHtml += `<div class="caveat-banner">${escapeHtml(sharedCaveat())}</div>`;

      details.innerHTML = detailsHtml;
      container.className = `result-container result-${status}`;
      container.style.display = 'block';
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showIssuerResult(result) {
      const container = document.getElementById('result-container');
      const icon = container.querySelector('.result-icon');
      const text = container.querySelector('.result-text');
      const details = container.querySelector('.result-details');

      const trustState = result.trustState || (result.verification?.valid ? TRUST_STATES.DOMAIN_VERIFIED_SIGNATURE : TRUST_STATES.UNVERIFIED);
      const issuerDomain = result.issuerDomain || result.verification?.issuerDomain || 'unknown';
      const validationLabel = resolveValidationLabel(result, issuerDomain);
      const claimedName = result.issuerClaimedName || result.verification?.issuerClaimedName || result.verification?.issuer?.name || 'not provided';
      const keyFingerprint = result.keyFingerprint || result.verification?.keyFingerprint || 'not available';
      const reason = result.verificationReason || (trustState === TRUST_STATES.DOMAIN_VERIFIED_SIGNATURE
        ? 'Signature is valid and key is currently discoverable for this domain.'
        : 'Issuer cannot be cryptographically verified.');
      const status = trustState === TRUST_STATES.DOMAIN_VERIFIED_SIGNATURE ? 'success' : 'error';

      icon.textContent = status === 'success' ? 'PASS' : 'FAIL';
      text.innerHTML = `${trustHeadline(trustState, issuerDomain, validationLabel)} ${trustBadge(trustState)}`;

      let detailsHtml = `<p class="result-summary"><strong>Type:</strong> ${escapeHtml(result.verification?.type || 'unknown')}</p>`;
      detailsHtml += '<div class="issuer-block">';
      detailsHtml += `<div class="issuer-block__domain">Issued by ${escapeHtml(issuerDomain)}</div>`;
      if (validationLabel) {
        detailsHtml += `<div class="issuer-block__meta">Validation label: ${statusPill('warn', validationLabel)}</div>`;
      }
      detailsHtml += `<div class="issuer-block__meta">Claimed name: ${escapeHtml(claimedName)}</div>`;
      detailsHtml += `<div class="issuer-block__fingerprint">Key fingerprint: ${escapeHtml(keyFingerprint)}</div>`;
      detailsHtml += '</div>';
      detailsHtml += `<div class="result-list"><p>Message</p><ul><li>${escapeHtml(result.verification?.message || reason)}</li></ul></div>`;
      detailsHtml += `<div class="caveat-banner">${escapeHtml(sharedCaveat())}</div>`;

      details.innerHTML = detailsHtml;
      container.className = `result-container result-${status}`;
      container.style.display = 'block';
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showError(message) {
      const container = document.getElementById('result-container');
      container.querySelector('.result-icon').textContent = 'FAIL';
      container.querySelector('.result-text').innerHTML = `Issuer cannot be cryptographically verified. ${trustBadge(TRUST_STATES.UNVERIFIED)}`;
      container.querySelector('.result-details').innerHTML = `
        <p class="result-summary">${escapeHtml(message)}</p>
        <div class="caveat-banner">${escapeHtml(sharedCaveat())}</div>
      `;
      container.className = 'result-container result-error';
      container.style.display = 'block';
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showLoading(button, buttonText, spinner) {
      button.disabled = true;
      buttonText.style.display = 'none';
      spinner.style.display = 'inline-block';
    }

    function hideLoading(button, buttonText, spinner) {
      button.disabled = false;
      buttonText.style.display = 'inline';
      spinner.style.display = 'none';
    }

    const params = new URLSearchParams(window.location.search);
    const queryUrl = params.get('url');
    const autoVerify = params.get('autoverify') === '1';
    if (queryUrl) {
      document.getElementById('badge-url').value = queryUrl;
      document.querySelector('[data-tab="url"]').click();
      if (autoVerify) {
        verifyByUrl(queryUrl);
      }
    }
  </script>
  <script src="/scripts.js"></script>
</body>
</html>
