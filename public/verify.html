<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify Credentials | Open Badges by Firmament Works</title>
  <meta name="description" content="Verify Open Badges and credential issuers by URL, JSON, or issuer profile.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <header class="site-header">
    <nav class="site-nav container" aria-label="Primary">
      <a href="/" class="logo">
        <span class="logo-mark" aria-hidden="true"></span>
        <span class="logo-main">Open Badges</span>
        <span class="logo-byline">by Firmament Works</span>
      </a>
      <button class="mobile-menu-btn" type="button" aria-expanded="false" aria-controls="primary-nav">Menu</button>
      <ul class="nav-links" id="primary-nav">
        <li><a href="/">Home</a></li>
        <li><a href="/verify.html" class="active">Verify</a></li>
        <li><a href="/vision.html">Vision</a></li>
      </ul>
    </nav>
  </header>

  <main id="main-content">
    <section class="verify-hero">
      <div class="container">
        <p class="kicker">Public Verifier</p>
        <h1 class="section-title" style="margin-bottom: 0.45rem;">Credential trust check</h1>
        <p class="section-lede">One panel for structure, issuer, and signature checks with auditable result details.</p>
        <div class="cta-row" style="margin-top: 0.85rem;">
          <a href="#" class="btn btn-primary" data-demo-fill-link>Load live test credential</a>
          <a href="/api.html" class="btn btn-secondary">How to issue + verify</a>
        </div>
      </div>
    </section>

    <section class="section" style="padding-top: 0.5rem;">
      <div class="container verify-layout">
        <section class="panel verify-panel">
          <div class="verify-tabs">
            <div class="verify-tab active" data-tab="url">By URL</div>
            <div class="verify-tab" data-tab="json">By JSON</div>
            <div class="verify-tab" data-tab="issuer">Issuer</div>
          </div>

          <div class="tab-content active" id="url-tab">
            <form id="url-form">
              <div class="form-group">
                <label class="form-label" for="badge-url">Badge or credential URL</label>
                <input type="url" id="badge-url" class="form-input" placeholder="https://example.com/badges/assertion.json" required>
                <small class="form-help">Fetches the resource and runs trust checks.</small>
              </div>
              <button type="submit" class="verify-button">
                <span class="button-text">Verify URL</span>
                <span class="loading-spinner" style="display: none;"></span>
              </button>
            </form>
          </div>

          <div class="tab-content" id="json-tab">
            <form id="json-form">
              <div class="form-group">
                <label class="form-label" for="badge-json">Badge JSON payload</label>
                <textarea id="badge-json" class="form-input form-textarea" placeholder='{"@context":"https://w3id.org/openbadges/v2","type":"Assertion",...}' required></textarea>
                <small class="form-help">Paste a full JSON object.</small>
              </div>
              <button type="submit" class="verify-button">
                <span class="button-text">Verify JSON</span>
                <span class="loading-spinner" style="display: none;"></span>
              </button>
            </form>
          </div>

          <div class="tab-content" id="issuer-tab">
            <form id="issuer-form">
              <div class="form-group">
                <label class="form-label" for="issuer-url">Issuer URL</label>
                <input type="url" id="issuer-url" class="form-input" placeholder="https://example.com/.well-known/openbadges-issuer.json" required>
                <small class="form-help">Checks issuer resource validity and accessibility.</small>
              </div>
              <button type="submit" class="verify-button">
                <span class="button-text">Verify issuer</span>
                <span class="loading-spinner" style="display: none;"></span>
              </button>
            </form>
          </div>

          <div id="result-container" class="result-container" role="status" aria-live="polite">
            <div class="result-title">
              <span class="result-icon"></span>
              <span class="result-text"></span>
            </div>
            <div class="result-details"></div>
          </div>

          <div class="examples">
            <h3>Quick examples</h3>
            <div class="example-links">
              <a href="#" class="example-link" data-example="live">Live hosted test</a>
              <a href="#" class="example-link" data-example="badge">Sample badge</a>
              <a href="#" class="example-link" data-example="issuer">Sample issuer</a>
              <a href="#" class="example-link" data-example="domain">openbadges.org</a>
            </div>
          </div>
        </section>

        <aside class="panel verify-panel scroll-animate">
          <h2 class="panel-title">How to read the verdict</h2>
          <div class="signal-stack">
            <div class="signal-row"><span class="signal-key">Structure</span><span class="status-pill status-pass">required fields pass</span></div>
            <div class="signal-row"><span class="signal-key">Issuer</span><span class="status-pill status-pass">profile reachable</span></div>
            <div class="signal-row"><span class="signal-key">Signature</span><span class="status-pill status-warn">strongly recommended</span></div>
          </div>
          <p class="signal-note" style="margin-top: 0.8rem;">
            Public verify endpoints include SSRF protections and are designed for untrusted input.
          </p>

          <div class="card" style="margin-top: 0.95rem;">
            <p class="eyebrow">Public endpoint</p>
            <code class="code-chip">GET /public/api/verify/badge/:badgeUrl(*)</code>
          </div>
          <div class="card" style="margin-top: 0.75rem;">
            <p class="eyebrow">Need more detail?</p>
            <a href="/api.html" class="btn btn-secondary">Open API reference</a>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <footer>
    <div class="container footer-row">
      <p>Open Badges by Firmament Works verifier.</p>
      <div class="footer-links">
        <a href="/">Home</a>
        <a href="/api.html">API</a>
        <a href="/vision.html">Vision</a>
        <a href="/llms.txt">llms.txt</a>
      </div>
    </div>
  </footer>

  <script>
    document.querySelectorAll('.verify-tab').forEach((tab) => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.verify-tab').forEach((t) => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        document.getElementById('result-container').style.display = 'none';
      });
    });

    const examples = {
      badge: JSON.stringify({
        '@context': 'https://w3id.org/openbadges/v2',
        type: 'Assertion',
        id: 'https://example.com/assertions/123',
        recipient: {
          type: 'email',
          hashed: false,
          identity: 'learner@example.com'
        },
        badge: 'https://example.com/badges/web-dev-101',
        issuedOn: '2026-01-15T00:00:00Z',
        verification: { type: 'hosted' }
      }, null, 2),
      issuer: JSON.stringify({
        '@context': 'https://w3id.org/openbadges/v2',
        type: 'Issuer',
        id: 'https://example.com/issuer',
        name: 'Example Learning Academy',
        url: 'https://example.com',
        email: 'badges@example.com'
      }, null, 2),
      domain: 'https://openbadges.org',
      live: `${window.location.origin}/samples/demo-openbadge-v3.json`
    };

    const statusClassMap = {
      pass: 'status-pass',
      warn: 'status-warn',
      fail: 'status-fail',
      skip: 'status-skip'
    };

    const statusTextMap = {
      pass: 'pass',
      warn: 'warn',
      fail: 'fail',
      skip: 'skip'
    };

    function escapeHtml(input) {
      return String(input)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function statusPill(state, text) {
      const css = statusClassMap[state] || 'status-skip';
      const label = escapeHtml(text || statusTextMap[state] || 'skip');
      return `<span class="status-pill ${css}">${label}</span>`;
    }

    function ladderRow(label, state, text) {
      return `<div class="result-ladder-row"><span class="label">${escapeHtml(label)}</span>${statusPill(state, text)}</div>`;
    }

    document.querySelectorAll('.example-link').forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const type = link.dataset.example;
        if (type === 'live') {
          document.querySelector('[data-tab="url"]').click();
          document.getElementById('badge-url').value = examples.live;
          return;
        }
        if (type === 'domain') {
          document.querySelector('[data-tab="issuer"]').click();
          document.getElementById('issuer-url').value = examples.domain;
          return;
        }

        document.querySelector('[data-tab="json"]').click();
        document.getElementById('badge-json').value = type === 'issuer' ? examples.issuer : examples.badge;
      });
    });

    document.getElementById('url-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await verifyByUrl(document.getElementById('badge-url').value);
    });

    document.getElementById('json-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await verifyByJson(document.getElementById('badge-json').value);
    });

    document.getElementById('issuer-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      await verifyIssuer(document.getElementById('issuer-url').value);
    });

    document.querySelectorAll('[data-demo-fill-link]').forEach((element) => {
      element.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelector('[data-tab="url"]').click();
        document.getElementById('badge-url').value = examples.live;
        verifyByUrl(examples.live);
      });
    });

    async function verifyByUrl(url) {
      const button = document.querySelector('#url-form .verify-button');
      const buttonText = button.querySelector('.button-text');
      const spinner = button.querySelector('.loading-spinner');

      try {
        showLoading(button, buttonText, spinner);
        const response = await fetch(`/public/api/verify/badge/${encodeURIComponent(url)}`);
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);
        showBadgeResult(result);
      } catch (error) {
        showError(`Verification failed: ${error.message}`);
      } finally {
        hideLoading(button, buttonText, spinner);
      }
    }

    async function verifyByJson(jsonStr) {
      const button = document.querySelector('#json-form .verify-button');
      const buttonText = button.querySelector('.button-text');
      const spinner = button.querySelector('.loading-spinner');

      try {
        showLoading(button, buttonText, spinner);
        const badgeData = JSON.parse(jsonStr);
        const response = await fetch('/public/api/verify/json', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ badgeData })
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);
        showBadgeResult(result);
      } catch (error) {
        if (error instanceof SyntaxError) {
          showError('Invalid JSON format.');
        } else {
          showError(`Verification failed: ${error.message}`);
        }
      } finally {
        hideLoading(button, buttonText, spinner);
      }
    }

    async function verifyIssuer(url) {
      const button = document.querySelector('#issuer-form .verify-button');
      const buttonText = button.querySelector('.button-text');
      const spinner = button.querySelector('.loading-spinner');

      try {
        showLoading(button, buttonText, spinner);
        const response = await fetch(`/public/api/verify/issuer/${encodeURIComponent(url)}`);
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || `HTTP ${response.status}`);
        showIssuerResult(result);
      } catch (error) {
        showError(`Issuer verification failed: ${error.message}`);
      } finally {
        hideLoading(button, buttonText, spinner);
      }
    }

    function showBadgeResult(result) {
      const container = document.getElementById('result-container');
      const icon = container.querySelector('.result-icon');
      const text = container.querySelector('.result-text');
      const details = container.querySelector('.result-details');

      const structureState = result.structure ? (result.structure.valid ? 'pass' : 'fail') : 'skip';
      const issuerState = result.issuer ? (result.issuer.valid ? 'pass' : 'fail') : 'skip';
      const signatureState = result.signature ? (result.signature.valid ? 'pass' : 'fail') : 'skip';

      let status = 'error';
      let headline = 'Credential failed verification';
      let verdictPill = statusPill('fail', 'invalid');

      if (result.valid && result.verificationLevel === 'cryptographically_verified') {
        status = 'success';
        headline = 'Credential cryptographically verified';
        verdictPill = statusPill('pass', 'high assurance');
      } else if (result.valid) {
        status = 'warning';
        headline = 'Credential valid with partial proof';
        verdictPill = statusPill('warn', 'review context');
      }

      icon.textContent = status === 'success' ? 'PASS' : status === 'warning' ? 'WARN' : 'FAIL';
      text.innerHTML = `${escapeHtml(headline)} ${verdictPill}`;

      let detailsHtml = '';
      detailsHtml += `<p class="result-summary"><strong>Version:</strong> ${escapeHtml(result.version || 'unknown')} &nbsp; <strong>Level:</strong> ${escapeHtml(result.verificationLevel || 'unknown')}</p>`;
      detailsHtml += '<div class="result-ladder">';
      detailsHtml += ladderRow('Structure', structureState, statusTextMap[structureState]);
      detailsHtml += ladderRow('Issuer', issuerState, statusTextMap[issuerState]);
      detailsHtml += ladderRow('Signature', signatureState, signatureState === 'skip' ? 'not present' : statusTextMap[signatureState]);
      detailsHtml += '</div>';

      if (result.structure?.errors?.length) {
        detailsHtml += '<div class="result-list"><p>Errors</p><ul>';
        result.structure.errors.forEach((entry) => {
          detailsHtml += `<li>${escapeHtml(entry)}</li>`;
        });
        detailsHtml += '</ul></div>';
      }

      if (result.structure?.warnings?.length) {
        detailsHtml += '<div class="result-list"><p>Warnings</p><ul>';
        result.structure.warnings.forEach((entry) => {
          detailsHtml += `<li>${escapeHtml(entry)}</li>`;
        });
        detailsHtml += '</ul></div>';
      }

      details.innerHTML = detailsHtml;
      container.className = `result-container result-${status}`;
      container.style.display = 'block';
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showIssuerResult(result) {
      const container = document.getElementById('result-container');
      const icon = container.querySelector('.result-icon');
      const text = container.querySelector('.result-text');
      const details = container.querySelector('.result-details');

      const valid = Boolean(result.valid && result.verification?.valid !== false);
      const status = valid ? 'success' : 'error';
      icon.textContent = valid ? 'PASS' : 'FAIL';
      text.innerHTML = `${valid ? 'Issuer resource verified' : 'Issuer resource failed verification'} ${statusPill(valid ? 'pass' : 'fail', valid ? 'valid' : 'invalid')}`;

      const profileState = valid ? 'pass' : 'fail';
      const message = result.verification?.message || 'No additional details returned by verifier';
      let detailsHtml = `<p class="result-summary"><strong>Type:</strong> ${escapeHtml(result.verification?.type || 'unknown')}</p>`;
      detailsHtml += '<div class="result-ladder">';
      detailsHtml += ladderRow('Issuer profile', profileState, statusTextMap[profileState]);
      detailsHtml += '</div>';
      detailsHtml += `<div class="result-list"><p>Message</p><ul><li>${escapeHtml(message)}</li></ul></div>`;

      if (result.verification?.error) {
        detailsHtml += `<div class="result-list"><p>Error</p><ul><li>${escapeHtml(result.verification.error)}</li></ul></div>`;
      }

      details.innerHTML = detailsHtml;
      container.className = `result-container result-${status}`;
      container.style.display = 'block';
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showError(message) {
      const container = document.getElementById('result-container');
      container.querySelector('.result-icon').textContent = 'FAIL';
      container.querySelector('.result-text').innerHTML = `Verifier request error ${statusPill('fail', 'request failed')}`;
      container.querySelector('.result-details').innerHTML = `<p class="result-summary">${escapeHtml(message)}</p>`;
      container.className = 'result-container result-error';
      container.style.display = 'block';
      container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function showLoading(button, buttonText, spinner) {
      button.disabled = true;
      buttonText.style.display = 'none';
      spinner.style.display = 'inline-block';
    }

    function hideLoading(button, buttonText, spinner) {
      button.disabled = false;
      buttonText.style.display = 'inline';
      spinner.style.display = 'none';
    }

    const params = new URLSearchParams(window.location.search);
    const queryUrl = params.get('url');
    const autoVerify = params.get('autoverify') === '1';
    if (queryUrl) {
      document.getElementById('badge-url').value = queryUrl;
      document.querySelector('[data-tab="url"]').click();
      if (autoVerify) {
        verifyByUrl(queryUrl);
      }
    }
  </script>
  <script src="/scripts.js"></script>
</body>
</html>
